<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>首页</title>
	<meta name="viewport" content="initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<!-- 引入weui样式 -->
	<link rel="stylesheet" href="lockcss/weui.css">
	<!-- 引入jq-weui样式 -->
	<link rel="stylesheet" href="lockcss/jquery-weui.min.css">
	<!--引入字体图标库-->
	<link rel="stylesheet" href="http://at.alicdn.com/t/font_715918_cvsd8eutpf.css">
	<!-- 引入全局样式 -->
	<link rel="stylesheet" href="lockcss/commen.css">

	<style>
		.weui-cells{
			width:94%;
			margin:auto;
			position:relative;
		}
		.adress{
			position:absolute;
			width:1rem;
			height:1.285rem;
			top:8px;
			right:25px;
		}
		.adress img{
			width:100%;
			height:auto;
		}
		.weui-navbar+.weui-tab__bd{
			/*padding:0.625rem;*/
			padding-top:3.9rem;
		}
		.weui-navbar{
			background:none;
		}
		.weui-navbar:after{
			border:none;
		}
		.weui-navbar__item{
			text-align: left;
		}
		.user{
			text-align: left;
		}
		.weui-navbar__item:after{
			border-right:none;
		}
		.weui-navbar__item.weui-bar__item--on{
			background:none;
			color:#00b79e;
		}
		.weui-navbar__item span{
			border-bottom:1px solid #fff;
			padding:5px;
		}
		.weui-navbar__item.weui-bar__item--on span{
			border-bottom:1px solid #00b79e;
			padding:5px;
		}
		.swiper-pagination-bullet{
			width:0.5rem;
			height:0.5rem;
		}
		.user img{
			width:2rem;
			height:2rem;
			border-radius: 50%;
			margin-left: 30px;
		}
		.weui-cells:before{
			border-top:none;
		}
		.weui-cells{
			margin-top: 1rem;
			height: 40px;
		}
		.weui-cell__bd{
			height: 40px;
		}
		.weui-input{
			text-align: center;
			font-size: 1rem;
			color: #c1c1c1;
		}
		.colorC{
			color: #656565;
		}
		.price{
			display: inline-block;
			width:100%;
			text-align: center;
			margin:2rem auto;
			color:#ccc;
			font-size: 12px;
		}
		.tabMsg {
			display: none;
		}
		.tabMsg .weui-input {
			text-align: left;
		}
		#tabHome{
		}
		#tabHome .tabHomeBtn{
			display: inline-block;
			width: 49%;
			text-align: center;
			margin:2rem auto;
		}
		#tabHome .priceCannel {
			width:100%;
			color:#ccc;
		}
		#tabHome .priceConfirm {
			width: 100%;
			/*border-radius: 25px;*/
		}
		#locksmither {
			padding: 10px 15px;
			border: 1px solid #ccc;
			box-shadow: 10px 10px 5px #ccc;
		}
		.weui-vcode-btn{
			height: 1.3125rem ;
			width: 5.3125rem;
			border: 1px solid #00b79e;
			color: #00b79e;
			border-radius: 2.3125rem;
			line-height:1.3125rem ;
			text-align: center;
			font-size: 12px;
		}
		.yzmBox{
			height: 50px;
			padding: 0;
		}
		 .yzmBox .weui-cell__ft{
			height: 3.375rem;
		}
		.result{
			width:90%;
			overflow: hidden;
			white-space: nowrap;/*不换行*/
			text-overflow:ellipsis;/*超出部分文字以...显示*/
		}
		#tab2,#tab3{height:27rem;}
		/*附近锁匠页*/
		.list{border-top:1px solid #D8D8D8;}
		.box{border:1px solid #D8D8D8;}
		.locksmith_list{padding:1rem 0.5rem 0.5rem;border-bottom: 1px solid #D8D8D8;height:4rem;width:82%;margin:auto;}
		.locksmith_list>ul{display: flex;align-items: center;position:relative;}
		.locksmith_list>ul>.portrait{border:1px solid #ccc;border-radius: 50%;overflow: hidden;width:3rem;height:3rem;margin-right:1rem;}
		.locksmith_list>ul>.portrait>img{width:100%;height:100%;}
		.locksmith_list>ul>li>h3{display: inline-block;font-weight: inherit;}
		.details{display:none;padding-top:0.5rem;}
		.details .tabAdress span{display:inline-block;color:#fff;float:left;width:10%;}
		.details .tabAdress input{float:left;width:80%;text-align: left;}
		.bot{width:80%;margin:auto;margin-top:1rem;}
		.bot p{color:red;}
		.bot ul{margin:0}
		.bot ul li{float:left;width:50%;text-align: center;}
		.bot ul li img{height:7rem;}
		.bot ul li p{color:#00b79e;text-align: center}
	</style>
	<!--弹窗-->
	<style type="text/css">

		.shade{
			display:none;
			overflow: hidden;
			position: fixed;
			width: 80%;
			left: 10%;
			right: 10%;
			top: 5%;
			bottom: 5%;
			z-index:999;
			background:#fff;
			box-shadow: 0 0 20px 2px #e2e2e2;
			border-radius: 10px;
		}
		.shade p{
			text-indent:2em;
			font-size:1.3rem;
			padding:0 0.5rem;
		}
		.shade h1{
			font-size:2rem;
			text-align: center;
			color: #00d0b4;
		}
		.read{
			font-size: 1rem;
			margin-top: 1rem;
		}
		.read input{
			width: 1rem;
			height: 1rem;
			margin-left: 20%;
		}
		.agree{
			margin-top: 5%;
			text-align: center;
			position:absolute;
			width:100%;
			bottom:2rem;
		}
		#cancel{
			width: 36%;
			height: 2rem;
			line-height: 1rem;
			background: linear-gradient(#00d0b4, #00b79e);
			font-size: 1.5rem;
			padding:0.3rem 0;
			border-radius: 10px;
			color: #FFFFFF;
		}
		#accept{
			width: 36%;
			height: 2rem;
			line-height:1rem;
			background: linear-gradient(#00d0b4, #00b79e);
			background: #C0C0C0;
			font-size: 1.5rem;
			border-radius: 10px;
			color: #FFFFFF;
			padding:0.3rem 0;
			margin-left:40px;
		}
	</style>
</head>
<body>
<!-- 遮罩层 -->
<div id="dialog">
	<div class="mask">
	</div>
	<div class="dialog_content">
		<div class="top">
			<i>
				<img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKHz17OjBzVIbJJG0jCAMHXM6Ehm4uzf6Q9EkHvRxNa08icrkkALM7pDOs3VPfmFu5Odq2z1yLYqiaw/132" alt="">
			</i>
			<p>
				{$nickname}
			</p>
		</div>
		<ul class="little_list">
			<li onclick="lockclick('我的订单')">
				<i class="iconfont icon-icondd1"></i>
				<span>我的订单</span>
				<span class="num">{$ordernumber}</span>
			</li>
			<li>
				<a href="tel:96116" id="dial">
					<i class="iconfont icon-kefu"></i>
					<span>联系客服</span>
				</a>
			</li>
		</ul>
	</div>
</div>
<!--弹窗-->
<!--<div class="shade" id='shade'>-->
	<!--<h1>免费开锁须知</h1>-->
	<!--<p class="content" id="content">-->
		<!--锁盾96116平台为民警执法，五保户，低保户，70岁以上孤寡老人提供免费开锁服务。为保障公共安全及更好的为您提供服务，请您主动出示您的证件或者办案证明，不属于民警办案需要的开锁-->
		<!--服务，按正常价格进行收费。非警务人员冒充民警下单的平台会自动报警。-->
	<!--</p>-->
	<!--<p class='content'>-->
		<!--感谢您使用96116开锁平台，祝您工作愉快-->
	<!--</p>-->
	<!--<div class="read">-->
		<!--<input type="checkBox" id='read'  >我以阅读并理解以上事项-->
	<!--</div>-->
	<!--<div class="agree">-->
		<!--<button id="cancel">取消</button>-->
		<!--<button id="accept">同意</button>-->
	<!--</div>-->
<!--</div>-->
<!-- 容器 -->
<div class="weui-tab">
	<div class="weui-navbar">
		<a class="weui-navbar__item user" id='user'>
			<img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKHz17OjBzVIbJJG0jCAMHXM6Ehm4uzf6Q9EkHvRxNa08icrkkALM7pDOs3VPfmFu5Odq2z1yLYqiaw/132" alt="">
		</a>
		<a id="unlock" class="weui-navbar__item weui-bar__item--on" value="1" href="#tab2" onclick='change(1)'>
			<span>开锁</span>
		</a>
		<!--<a id="changeOfLock" class="weui-navbar__item" href="#tab3" value="2" onclick='change(2)'>-->
			<!--<span>换锁</span>-->
		<!--</a>-->
		<!--<a id="locksmith" class="weui-navbar__item" href="#tab4" onclick='change(3)'>-->
			<!--<span>预约锁匠</span>-->
		<!--</a>-->
	</div>
	<div class="weui-tab__bd">
		<!-- 轮播 -->
		<div class="swiper-container">
			<div class="swiper-wrapper">
				<div class="swiper-slide">
					<img src="lockimg/swiper-2.png"/>
				</div>
				<div class="swiper-slide">
					<img src="lockimg/swiper-2.jpg"/>
				</div>
				<div class="swiper-slide">
					<img src="lockimg/swiper-3.jpg"/>
				</div>
			</div>
			<div class="swiper-pagination">
			</div>
		</div>
		<div id="tab2" class="weui-tab__bd-item weui-tab__bd-item--active">
			<!-- 地址输入-->
			<div class="tabAdress">
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input colorC result" type="text" placeholder="正在获取开锁位置" readonly="true" value="">
						</div>
					</div>
					<div class="adress">
						<img src="lockimg/index_address.png" alt="">
					</div>
				</div>
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input " type="text" placeholder="请输入您的门牌号码方便师傅更快到达" class="particular">
						</div>
					</div>
				</div>
				<a href="javascript:;" class="weui-btn weui-btn_orange confirmSubmit" style='width:80%;border-radius: 2px;margin-top:2rem;'>安全下单</a>
				<!--<div class="bot">-->
					<!--<p style="font-size:1.2rem">警民通用户专享免费开锁服务：</p>-->
					<!--<ul>-->
						<!--<li class="polic" id="police">-->
							<!--&lt;!&ndash;<img src="img/police.jpg" alt="">&ndash;&gt;-->
							<!--<img src="img/police.png" alt="">-->
							<!--<p>民警执法免费开锁</p>-->
						<!--</li>-->
						<!--<li class="dibao" id="dihao">-->
							<!--<img src="img/oldman.png" alt="">-->
							<!--<p>低保免费开锁</p>-->
						<!--</li>-->
					<!--</ul>-->
				<!--</div>-->
			</div>
			<!-- 短信验证-->
			<div class="tabMsg">
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input phone" name="phone_number" type="text" placeholder="请输入手机号"/>
						</div>
					</div>
				</div>
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input yancode" name="verify_code" type="text" placeholder="请输入验证码"/>
						</div>
					</div>
					<div class="code code2" onClick="obtainCode(document.getElementsByClassName('code2'))">
						<input class="btn_type2 yanzhengcode" type="button" value="获取验证码" />
					</div>
				</div>

				<a href="javascript:;" class="weui-btn weui-btn_orange apply" style='width:80%;border-radius: 2px;margin-top:2rem;'>安全下单</a>
			</div>
		</div>
		<div id="tab3" class="weui-tab__bd-item">
			<!-- 地址输入-->
			<div class="tabAdress">
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input colorC result" type="text" placeholder="正在获取开锁位置" value="">
						</div>
					</div>
					<div class="adress">
						<img src="lockimg/index_address.png" alt="">
					</div>
				</div>
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input " type="text" placeholder="请输入您的门牌号码方便师傅更快到达" class="particular">
						</div>
					</div>
				</div>
				<a href="javascript:;" class="weui-btn weui-btn_orange confirmSubmit" style='width:80%;border-radius: 2px;margin-top:2rem;'>安全下单</a>
				<!--<div class="bot">-->
				<!--<p style="font-size:1.2rem">警民通用户专享免费开锁服务：</p>-->
				<!--<ul>-->
					<!--<li class="polic">-->
						<!--&lt;!&ndash;<img src="img/police.jpg" alt="">&ndash;&gt;-->
						<!--<img src="img/police.png" alt="">-->
						<!--<p>民警执法免费开锁</p>-->
					<!--</li>-->
					<!--<li class="dibao">-->
						<!--<img src="img/oldman.png" alt="">-->
						<!--<p>低保免费开锁</p>-->
					<!--</li>-->
				<!--</ul>-->
			<!--</div>-->
			</div>
			<!-- 短信验证-->
			<div class="tabMsg">
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input phone" name="phone_number" type="text" placeholder="请输入手机号"/>
						</div>
					</div>
				</div>
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<input class="weui-input yancode" name="verify_code" type="text" placeholder="请输入验证码"/>
						</div>
					</div>
					<div class="code code3" onClick="obtainCode(document.getElementsByClassName('code3'))">
						<input class="btn_type2 yanzhengcode" type="button" value="获取验证码"/>
					</div>
				</div>

				<a href="javascript:;" class="weui-btn weui-btn_orange apply" style='width:80%;border-radius: 2px;margin-top:2rem;'>安全下单</a>
			</div>
		</div>
		<div id="tab4" class="weui-tab__bd-item">
			<div class="list">
				<div class="weui-loadmore">
					<i class="weui-loading"></i>
					<span class="weui-loadmore__tips">正在加载</span>
				</div>
			</div>
			<div class="details">
				<div class="detail"></div>
				<!-- 地址输入-->
				<div class="tabAdress">
					<div class="weui-cells">
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<span>*</span>
								<input class="weui-input colorC result" type="text" placeholder="正在获取开锁位置" value="">
							</div>
						</div>
						<div class="adress">
							<img src="lockimg/index_address.png" alt="">
						</div>
					</div>
					<div class="weui-cells">
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<span>*</span>
								<input class="weui-input " type="text" placeholder="请输入您的门牌号码方便师傅更快到达" class="particular">
							</div>
						</div>
					</div>
					<div class="weui-cells">
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<span style="color:red">*</span>
								<input class="weui-input time" type="text" placeholder="请输入时间" id='datetime-picker'/>
							</div>
						</div>
					</div>
					<a href="javascript:;" id="confirmSubmit" class="weui-btn weui-btn_orange" style='width:80%;border-radius: 2px;margin-top:2rem;'>安全下单</a>
					<!--<a class="price" href="#">查看收费标准</a>-->
				</div>
				<!-- 短信验证-->
				<div class="tabMsg">
					<div class="weui-cells">
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<input class="weui-input phone" name="phone_number" type="text" placeholder="请输入手机号"/>
							</div>
						</div>
					</div>
					<div class="weui-cells">
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<input class="weui-input yancode" name="verify_code" type="text" placeholder="请输入验证码"/>
							</div>
						</div>
						<div class="code code4" onClick="obtainCode(document.getElementsByClassName('code4'))">
							<input class="btn_type2 yanzhengcode" type="button" value="获取验证码" />
						</div>
					</div>
					<a href="javascript:;" id='appointment' class="weui-btn weui-btn_orange" style='width:80%;border-radius: 2px;margin-top:2rem;'>安全下单</a>
				</div>
			</div>
		</div>
	</div>
</div>

<!--遮罩层-->

<!-- 引入jquery -->
<script src='lockjavascript/jquery.min.js'></script>
<!-- 引入jq-weui -->
<script src='lockjavascript/jquery-weui.min.js'></script>
<!-- 引入swiper -->
<script src='lockjavascript/swiper.min.js'></script>
<!-- 引入公共js -->
<script src='lockjavascript/commen.js'></script>
<!-- 引入高德地图css -->
<link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
<!-- 引入高德地图js -->
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.6&key=165bef343361053f2c0442fcb833dcc2&plugin=AMap.Geocoder"></script>
<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
<script type="text/javascript" src="https://3gimg.qq.com/lightmap/components/geolocation/geolocation.min.js"></script>
<!-- 引入微信公众平台js -->
<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script>


    /**
     * js获取url参数值
     */
    var key = true
    function request(paras) {
        var url = location.href;
        var paraString = url.substring(url.indexOf("?") + 1, url.length).split("&");
        var paraObj = {};
        for (i = 0; j = paraString[i]; i++) {
            paraObj[j.substring(0, j.indexOf("=")).toLowerCase()] = j.substring(j.indexOf("=") + 1, j.length);
        }
        var returnValue = paraObj[paras.toLowerCase()];
        if (typeof (returnValue) == "undefined") {
            return "";
        } else {
            return returnValue;
        }
    }
    var source = decodeURI(request("source"));
    console.log(source);

    var height = $('.swiper-slide img').height();//获取图片高度
    $('input,textarea').on('blur',function(){
        window.scroll(0,0);
    });
	var info={};
	var areacode = {};
    // 地址转坐标
    var lng,lat;
    var map = new AMap.Map("container", {
        resizeEnable: true
    });
    function geocoder(address) {
        var geocoder = new AMap.Geocoder({
            city: "035", //城市，默认：“全国”
            radius: 1000 //范围，默认：500
        });
        //地理编码,返回地理编码结果
        geocoder.getLocation(address, function(status, result) {
            if (status === 'complete' && result.info === 'OK') {
                lng = geocoder_Call(result)[0];
                lat = geocoder_Call(result)[1];
            }
        });
    }
    //地理编码返回结果展示
    function geocoder_Call(data) {
        var resultStr = "";
        //地理编码结果数组
        var geocode = data.geocodes;
        for (var i = 0; i < geocode.length; i++) {
            var arr = [];
            arr.push(geocode[i].location.getLng(),geocode[i].location.getLat());
            return  arr
        }
    }
    //轮播属性设置
    $(".swiper-container").swiper({
        loop: true,
        autoplay: 3000
    });
    $('.adress').click(function(){
        location = location;
	});
    $("#datetime-picker").datetimePicker();  //选择时间控件
	var ordertype = 1;// 开锁1 换锁2
    var lnglatXY; // 经纬度
    // var mobile = {$mobile}; // 电话号码
    // var mobile = null; // 电话号码
    var address;
    // alert(mobile);
    // 点击开锁
    $("#unlock").click(function(){
        ordertype = 1
        orderTypeChange();
    });
    // 点击换锁
    $("#changeOfLock").click(function(){
        ordertype = 2
        orderTypeChange();
    });
    function orderTypeChange(obj) {
        $(".tabAdress").show();
        $(".tabMsg").hide();
    };

    // 点击确认提交 隐藏地址页面  显示短信验证页面
    $(".confirmSubmit").click(function(){
        $(".tabAdress").hide();
        address = $('.result').val();
        geocoder($('.result').val());
        setTimeout(function(){
            info.lat = lat;
            info.lng = lng;
        },2000);
        // if(mobile) {
        //     // 向后端发送数据
        //     sendAddressMsg()
        // } else {
            // 手机验证页面
            $(".tabMsg").show();
    //     }
    });
    // 轮播切换
    function change(id){
        if(id == 3){
            $(".swiper-container").css({'position': 'absolute','top': -height+'px'});
        }else{
            $(".swiper-container").css({'position': 'relative','top': '0'});
        }
    }
    // 获取验证码
    var code = $('.yanzhengcode');
    var phoneNumber;
    // var verifyCode = $("input[name='verify_code']");
    var verifyCode;
    var apply = $('.apply');
    var time;
    var second;
    var flag = 0;
    var num = '';
    function msg_time(dom){
        clearInterval(time);
        time = setInterval(function(){
            if(second < 1){
                dom.val('获取验证码').css('background-color','none');
                $('.yanzhengcode').parent().css('pointer-events','auto');
            }else{
                var s = second--;
                dom.val(s+'s后重新获取');
            }
        },1000)
    }
    /*
    发送短信验证码
     */
	function obtainCode(dom){
        var _this = $(dom[0]).find('input');
        var mobile = $(dom[0]).parent().prev().find('input').val();
        phoneNumber = $(dom[0]).parent().prev().find('input');
        verifyCode =  $(dom[0]).prev().find('input');
		if(mobile.match(/^1[3|4|5|6|7|8|9]\d{9}$/)){
			$.ajax({
				type:'POST',
				dataType:'json',
				data:{mobile:mobile},
				url:"/lockshield/sms/code",
				success:function(data){
					if(data.result.Message=='OK'){
						second = 60;
						_this.val(second+'s后重新获取').css({'background':'#00B79E','color':'#fff'});
						$(_this).parent().css('pointer-events','none');
						num = data['code'];
						// alert(num);
						msg_time(_this);
					}else{
						_this.removeAttr('disabled');
						if(data.msg){
							try{
								app.toast(data.msg);
							}catch(err){
								$.toast(data.msg,'text');
							}
						}
					}
				}
			})
		}else{
			$.alert("手机号码不正确，请您重新输入！");
			 _this.removeAttr('disabled');
		}
	}
    /*
    安全短信下单
     */
    apply.on('click',function(){
        var mobile = phoneNumber.val();
        var code = verifyCode.val();
        if(!mobile.match(/^1[3|4|5|7|8|9]\d{9}$/)){
            $.alert("手机号码不正确，请您重新输入！");
            return false;
        }
        if(num != code){
            try{
                app.toast('验证码不正确，请您重新获取！');
            }catch(err){
                $.toast('验证码不正确，请您重新获取！','text');
            }
            return false;
        }
        flag ++;
        if(flag != 1)return false;
        $.showLoading();
        $.ajax({
            type: 'post',
            dataType: 'json',
            data: {
                ordertype: ordertype,
                lat: info.lat,
                lng: info.lng,
                province:areacode.province,
				city:areacode.city,
                region:areacode.area,
                mobile: mobile,
                address: address,
                addressparticular: $('.particular').val()
            },
            url: '/lockshield/order/lockOrder',
            success: function (data) {
                if(data['state'] == 1) {
                    $('.phone').val('');
                    $('.yancode').val('');
                    if(data.matchingstatus == 1){
                        $.ajax({
                            type: 'post',
                            dataType: 'json',
                            data: {
                                ubid: data['ubid'],
                             },
                            url: '/lockshield/Distance/ordermatching',
                            success: function (msg) {
                                $.hideLoading();
								if(msg.code == 0){
									window.location.href = '/lockshield/order/wait?ubid='+msg.data.ubid+'&ordertype='+msg.data.ordertype;
								}else{
									window.location.href = '/lockshield/order/thelock?'+'ubid='+data['ubid']+'&ordertype='+ordertype;
								}
							}
						})
					}else{
                        window.location.href = '/lockshield/order/wait?'+'ubid='+data['ubid']+'&ordertype='+ordertype;
					}
                } else {
                    $.alert('下单失败')
                }
            }
        })
    });

    // 向后端发送开换锁 经纬度 电话 地址 等信息
    function sendAddressMsg() {
        $.ajax({
            type: 'post',
            dataType: 'json',
            data: {
                ordertype: ordertype,
                lat: lnglatXY[1],
                lng: lnglatXY[0],
                mobile: mobile,
                address: address,
                addressparticular: $('.particular').val()
            },
            url: '/lockshield/order/lockOrder',
            success: function (data) {
                if(data['state'] == 1) {
                    // alert(data['ubid']);
                    $.alert('下单成功')
                } else {
                    $.alert('下单失败')
                }
            }
        })
    };

    // 预约锁匠
    // $("#locksmith").click(function () {
    //     $('#tabPeoresult').val(address)
    // })
  	wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: '{$signPackage.appId}', // 必填，公众号的唯一标识
        timestamp: '{$signPackage.timestamp}', // 必填，生成签名的时间戳
        nonceStr: '{$signPackage.nonceStr}', // 必填，生成签名的随机串
        signature: '{$signPackage.signature}',// 必填，签名，见附录1
        jsApiList: [
            'getLocation'
        ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });
    wx.ready(function(){
        wx.getLocation({
            success: function (res) {
                var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                var speed = res.speed; // 速度，以米/每秒计
                var accuracy = res.accuracy; // 位置精度
                regeocoder(longitude, latitude);
            }
        });
    });
    wx.error(function(res){});
    // 获取用户位置
    var map = new AMap.Map("container", {
        resizeEnable: true,
        zoom: 18
    })
    // 逆地理编码
    function regeocoder(longitude, latitude) {
        //标准坐标转化为高德地图
        var str = [longitude, latitude]
        AMap.convertFrom(str , 'gps', function(status, result) {
            var strlnglatXY = result.locations.toString()//已知点坐标
            lnglatXY =  strlnglatXY.split(',');
            var geocoder = new AMap.Geocoder({
                radius: 1000,
                extensions: "all"
            });
            geocoder.getAddress(lnglatXY, function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    geocoder_CallBack(result);
                }
            });
            var marker = new AMap.Marker({  //加点
                map: map,
                position: lnglatXY
            });
            map.setFitView();
        })
    }
    function geocoder_CallBack(data) {
        var str = data.regeocode.addressComponent.adcode;
        address = data.regeocode.formattedAddress; //返回地址描述
        $(".result").val(address);
        areacode.province = str.substr(0, 2) + '0000';
        areacode.city = str.substr(0, 4) + '00';
        areacode.area = str;
    }
    var flags = true;
    //附近锁匠排序以及赋值
	$('#locksmith').click(function () {
	    if(flags){
            flags = false;
            ordertype = 3
            orderTypeChange();
            $('.list').css('display','block');
            $('.details').css('display','none');
            setTimeout(function(){
                $.ajax({
                    type: 'post',
                    dataType: 'json',
                    data: {
                        lat: lnglatXY[1],
                        lng: lnglatXY[0]
                    },
                    url: '/lockshield/Distance/locksmith',
                    success: function (msg) {
                        flags = true;
                        $('.list').html('');
                        if(msg){
                            var res = msg.data;
                            for(i=0;i<res.length-1;i++){
                                for(j=0;j<res.length-1-i;j++){
                                    if(res[j]['distance']>res[j+1]['distance']){
                                        var temp = res[j];
                                        res[j] = res[j+1];
                                        res[j+1] = temp;
                                    }
                                }
                            }
                            msg.data.forEach(function(data){
                                $('.list').append(
                                    '<div class="locksmith_list" data-lid="'+data.lid+'"data-phone="'+data.mobile+'">'+
                                    '<ul>'+
                                    '<li class="portrait">'+
                                    '<img src="'+data.locksmithphoto+'" alt="">'+
                                    '<li>'+
                                    '<h3>'+data.name+'</h3><span style="margin-left:5px;color:#FE6701;"><i class="iconfont icon-icon"></i><span>8.9</span></span>'+
                                    '<p style="color:#D8D8D8;">上岗证编号:'+data.licensenumber+'</p>'+
                                    '</li>'+
                                    '<li style="position:absolute;top:-5px;right:0;">'+
                                    '<i class="iconfont icon-time" style="color:#00b79e;font-size:20px;margin-left:1rem;"></i>'+
                                    '<p>'+data.distance+'公里</p>'+
                                    '</li>'+
                                    '</ul>'+
                                    '</div>'
                                );
                            });
                        }else{
                            $('.list').html('暂无数据');
                        }
                    },
                })
            },1000);
		}
    })

	// 锁匠详情
    $('.list').on('click', '.locksmith_list', function(){
        $('.detail').html('');
        var _id = this.getAttribute('data-lid');
        var phone = this.getAttribute('data-phone');
        $('.details').css('display','block');
        $('.list').css('display','none');
        var data=$(this).children().children();
        var imgadress = $(data[0]).children()[0].currentSrc;
        var name = $(data[1]).children('h3').html();
        var score = $(data[1]).children('span').children('span').html();
        var code = $(data[1]).children('p').html();
        var reg =/[\u4e00-\u9fa5]/g;
        var distance = $(data[2]).children('p')[0].innerHTML.replace(reg, "");
        $('.detail').append(
            '<div class="locksmith_list box" data-lid="'+_id+'" style="padding:0.5rem 0.5rem 0.2rem;box-shadow:-1px 2px 5px -1px #888888;">'+
            '<ul>'+
            '<li class="portrait">'+
            '<img src="'+imgadress+'" alt="">'+
            '<li>'+
            '<h3>'+name+'</h3><span style="margin-left:5px;color:#FE6701;"><i class="iconfont icon-icon"></i><span>'+score+'</span></span>'+
            '<p style="color:#D8D8D8;">'+ code +'</p>'+
            '</li>'+
            '<li style="position:absolute;top:0px;right:5px;">'+
			// '<a href="tel:'+phone+'"><i class="iconfont icon-dadianhua" style="color:#00b79e;font-size:2.3rem;"></i></a>'+
            '<a href="tel:96116"><i class="iconfont icon-dadianhua" style="color:#00b79e;font-size:2.3rem;"></i></a>'+
            '</li>'+
            '</ul>'+
            '</div>'
        );
    })

    // 预约点击确认提交 隐藏地址页面  显示短信验证页面
    $("#confirmSubmit").click(function(){
        if(!$('#datetime-picker').val()){
            $.alert('预约时间不能为空！')
            return
        }
        $(".tabAdress").hide();
        // 手机验证页面
        $(".tabMsg").show();
    });
    $('#appointment').click(function(){
        var mobile = phoneNumber.val();
        var code = verifyCode.val();
        if(!mobile.match(/^1[3|4|5|7|8|9]\d{9}$/)){
            $.alert("手机号码不正确，请您重新输入！");
            return false;
        }
        if(num != code){
            // try{
            //     app.toast('验证码不正确，请您重新获取！');
            // }catch(err){
            //     $.toast('验证码不正确，请您重新获取！','text');
            // }
            $.toast('验证码不正确，请您重新获取！','text');
            verifyCode.val(' ');
            return false;
        }
        flag ++;
        if(flag != 1)return false;
        // 向后端发送数据
        $.ajax({
            type: 'post',
            dataType: 'json',
            data: {
                lid:$(".box").attr("data-lid"),
                ordertype: ordertype,
                lat: lnglatXY[1],
                lng: lnglatXY[0],
                mobile: mobile,
                address: address,
                addressparticular: $('.particular').val(),
                appointmenttime:$('#datetime-picker').val(),
            },
            url: '/lockshield/order/appointOrder',
            success: function (data) {
                if(data['state'] == 1) {
                    // alert(data['ubid']);
                    // $.alert('预约成功');
                    window.location.href = '/lockshield/order/thelock?'+'ubid='+data['ubid']+'&ordertype='+ordertype;
                } else {
                    $.alert('下单失败')
                }
            }
        })
    });

    //导航栏页面跳转
    function lockclick(ms) {
        if (ms == '我的订单') {
            window.location.href = "/lockshield/order/orderlist?order=1";
        }
    }
</script>
<script type="text/javascript">
	$('.polic').click(function(){
	    $('#shade').css('display','block')
	});
    $('.dibao').click(function(){
        $('#shade').css('display','block')
    });
    var accept = document.getElementById("accept");
    var read = document.getElementById("read");
    var cancel = document.getElementById("cancel");
    read.onclick = function(){
        if(read.checked == true){
            accept.style.background= "#00b79e"
        }else{
            accept.style.background= "#C0C0C0"
        }
    }

    accept.onclick = function(){
        var read = document.getElementById('read');
        if(read.checked){
            document.getElementById('shade').style.display= "none"
            window.location.href = "tel:96116";
         }
    }

    cancel.onclick = function(){
        document.getElementById('shade').style.display= "none"
    }



</script>
</body>
</html>